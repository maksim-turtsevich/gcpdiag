steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/gcp-coe-msp-sandbox/gcpdiag:$COMMIT_SHA', '-t', 'gcr.io/gcp-coe-msp-sandbox/gcpdiag:latest','.']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/gcp-coe-msp-sandbox/gcpdiag:$COMMIT_SHA']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/gcp-coe-msp-sandbox/gcpdiag:latest']
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['run', 'deploy', 'gcpdiag-prod', '--image=gcr.io/gcp-coe-msp-sandbox/gcpdiag:latest', '--update-secrets=jira_token=jira-token:2', '--region=europe-central2', '--min-instances=2', '--port=8000']

options:
  logging: CLOUD_LOGGING_ONLY
